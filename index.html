<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Longitudinal Wave Simulation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #f0f3f5;
            color: #333;
            margin-top: 20px;
        }

        .simulation-container {
            width: 800px;
            border: 1px solid #b0bec5;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 20px;
        }

        .particle-row {
            position: relative;
            height: 40px;
            width: 100%;
            border-bottom: 1px dashed #90a4ae;
        }

        #equilibrium-row {
            border-bottom: 1px solid #78909c;
            margin-bottom: 20px;
        }
        
        #equilibrium-row::before {
            content: "Equilibrium Positions";
            position: absolute;
            left: -150px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9em;
            color: #546e7a;
            width: 140px;
            text-align: right;
        }

        #wave-row::before {
            content: "Moving Particles";
            position: absolute;
            left: -150px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9em;
            color: #546e7a;
            width: 140px;
            text-align: right;
        }

        .particle {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: background-color 0.2s;
        }

        .equilibrium-particle {
            background-color: #455a64;
            cursor: pointer;
            z-index: 10;
        }

        .equilibrium-particle:hover {
            background-color: #607d8b;
        }

        .moving-particle {
            background-color: #1e88e5;
            z-index: 5;
            width: 14px;
            height: 14px;
        }

        .graph-container {
            width: 100%;
            height: 200px;
            margin-top: 20px;
            position: relative;
        }
        
        .graph-container::before {
            content: "Displacement Graph";
            position: absolute;
            left: -150px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9em;
            color: #546e7a;
            width: 140px;
            text-align: right;
        }

        canvas {
            width: 100%;
            height: 100%;
            background-color: #eceff1;
            border-radius: 4px;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .controls button {
            font-size: 1em;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background-color: #0277bd;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .controls button:hover {
            background-color: #039be5;
        }
        
        .controls button:active {
            background-color: #01579b;
        }
    </style>
</head>
<body>

    <div class="simulation-container">
        <div id="equilibrium-row" class="particle-row"></div>
        
        <div id="wave-row" class="particle-row"></div>

        <div class="graph-container">
            <canvas id="wave-graph"></canvas>
        </div>

        <div class="controls">
            <button id="play-pause-btn">Play</button>
            <button id="step-btn">Step</button>
            <button id="reset-btn">Reset</button>
            <button id="direction-btn">Direction: L-to-R</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM Elements ---
            const eqRow = document.getElementById('equilibrium-row');
            const waveRow = document.getElementById('wave-row');
            const canvas = document.getElementById('wave-graph');
            const ctx = canvas.getContext('2d');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const stepBtn = document.getElementById('step-btn');
            const resetBtn = document.getElementById('reset-btn');
            const directionBtn = document.getElementById('direction-btn');

            // --- Simulation Parameters ---
            const NUM_PARTICLES = 40;
            const AMPLITUDE = 60; // Max displacement in pixels
            const WAVELENGTH = 300; // Wavelength in pixels
            const WAVE_SPEED = 0.05; // Angular frequency (controls speed)
            const MAX_SELECTED = 6;
            
            // Selection colors
            const SELECTION_COLORS = [
                '#e53935', // red
                '#39b54a', // green
                '#f57c00', // orange
                '#9c27b0', // purple
                '#03a9f4', // light blue
                '#fbc02d'  // yellow
            ];

            // --- State Variables ---
            let particles = [];
            let eqParticleDOMs = [];
            let movingParticleDOMs = [];
            let selectedParticleIds = new Set();
            let simulationTime = 0;
            let isPlaying = false;
            let animationFrameId = null;
            let waveDirection = 1; // 1 for L-to-R, -1 for R-to-L
            let canvasWidth, canvasHeight, graphCenterY;

            // --- Wave Constants ---
            // A < lambda / (2*PI) to prevent overlap. 60 < 300 / (2*PI) -> 60 < 47.7 (FALSE)
            // Let's adjust Amplitude to be safe.
            const SAFE_AMPLITUDE = 40; // 40 < 47.7 (TRUE)
            const K = (2 * Math.PI) / WAVELENGTH; // Wavenumber

            /**
             * Resizes canvas to match its display size.
             */
            function resizeCanvas() {
                canvasWidth = canvas.clientWidth;
                canvasHeight = canvas.clientHeight;
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                graphCenterY = canvasHeight / 2;
            }

            /**
             * Calculates displacement for a particle at equilibrium position x at time t.
             */
            function getDisplacement(x, t) {
                return SAFE_AMPLITUDE * Math.sin(K * x - waveDirection * WAVE_SPEED * t);
            }

            /**
             * Initializes the simulation.
             */
            function init() {
                resizeCanvas();
                particles = [];
                eqParticleDOMs = [];
                movingParticleDOMs = [];
                selectedParticleIds.clear();
                simulationTime = 0;
                isPlaying = false;
                playPauseBtn.textContent = 'Play';
                
                eqRow.innerHTML = '';
                waveRow.innerHTML = '';

                const particleSpacing = canvasWidth / (NUM_PARTICLES + 1);

                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const id = i;
                    const equilibriumX = particleSpacing * (i + 1);

                    // Create particle data object
                    particles.push({
                        id: id,
                        equilibriumX: equilibriumX,
                        currentX: equilibriumX,
                        displacement: 0,
                        color: null
                    });

                    // Create equilibrium particle DOM element
                    const eqParticle = document.createElement('div');
                    eqParticle.className = 'particle equilibrium-particle';
                    eqParticle.style.left = `${equilibriumX}px`;
                    eqParticle.dataset.id = id;
                    eqParticle.addEventListener('click', () => toggleSelectParticle(id));
                    eqRow.appendChild(eqParticle);
                    eqParticleDOMs.push(eqParticle);

                    // Create moving particle DOM element
                    const movingParticle = document.createElement('div');
                    movingParticle.className = 'particle moving-particle';
                    movingParticle.style.left = `${equilibriumX}px`;
                    waveRow.appendChild(movingParticle);
                    movingParticleDOMs.push(movingParticle);
                }
                
                update();
                draw();
            }

            /**
             * Handles selection/deselection of a particle.
             */
            function toggleSelectParticle(id) {
                const eqParticle = eqParticleDOMs[id];
                const movingParticle = movingParticleDOMs[id];
                const particleData = particles[id];

                if (selectedParticleIds.has(id)) {
                    // Deselect
                    selectedParticleIds.delete(id);
                    particleData.color = null;
                    eqParticle.style.backgroundColor = '#455a64';
                    movingParticle.style.backgroundColor = '#1e88e5';
                } else if (selectedParticleIds.size < MAX_SELECTED) {
                    // Select
                    selectedParticleIds.add(id);
                    // Find the first available color
                    const usedColors = Array.from(selectedParticleIds).map(pid => particles[pid].color);
                    const color = SELECTION_COLORS.find(c => !usedColors.includes(c));
                    
                    particleData.color = color;
                    eqParticle.style.backgroundColor = color;
                    movingParticle.style.backgroundColor = color;
                }
                
                // Redraw to update bars
                if (!isPlaying) {
                    draw();
                }
            }

            /**
             * Updates the state of all particles.
             */
            function update() {
                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const p = particles[i];
                    p.displacement = getDisplacement(p.equilibriumX, simulationTime);
                    p.currentX = p.equilibriumX + p.displacement;
                    
                    // Update moving particle DOM
                    movingParticleDOMs[i].style.transform = `translate(${p.displacement - 8}px, -50%)`;
                }
            }

            /**
             * Draws the graph and selection bars on the canvas.
             */
            function draw() {
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);

                // 1. Draw equilibrium line (x-axis)
                ctx.beginPath();
                ctx.moveTo(0, graphCenterY);
                ctx.lineTo(canvasWidth, graphCenterY);
                ctx.strokeStyle = '#546e7a';
                ctx.lineWidth = 2;
                ctx.stroke();

                // 2. Draw the displacement graph
                ctx.beginPath();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#1e88e5';
                for (let x = 0; x <= canvasWidth; x++) {
                    const displacement = getDisplacement(x, simulationTime);
                    const y = graphCenterY - displacement; // y=0 is top, so subtract
                    if (x === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                
                // 3. Draw bars for selected particles
                selectedParticleIds.forEach(id => {
                    const p = particles[id];
                    ctx.fillStyle = p.color;
                    ctx.strokeStyle = p.color;
                    ctx.lineWidth = 3;
                    
                    const barTopY = graphCenterY - p.displacement;
                    
                    ctx.beginPath();
                    ctx.moveTo(p.equilibriumX, graphCenterY);
                    ctx.lineTo(p.equilibriumX, barTopY);
                    ctx.stroke();
                });
            }

            /**
             * The main animation loop.
             */
            function loop() {
                if (!isPlaying) return;
                
                simulationTime++;
                update();
                draw();
                
                animationFrameId = requestAnimationFrame(loop);
            }

            /**
             * Toggles the play/pause state of the simulation.
             */
            function togglePlayPause() {
                isPlaying = !isPlaying;
                if (isPlaying) {
                    playPauseBtn.textContent = 'Pause';
                    loop();
                } else {
                    playPauseBtn.textContent = 'Play';
                    cancelAnimationFrame(animationFrameId);
                }
            }

            /**
             * Advances the simulation by one step.
             */
            function step() {
                if (isPlaying) {
                    togglePlayPause();
                }
                simulationTime += 5; // A noticeable step
                update();
                draw();
            }

            /**
* Resets the entire simulation.
*/
            function reset() {
                if (isPlaying) {
                    togglePlayPause(); // This also cancels the animation frame
                }
                init(); // Re-initialize everything
            }

            /**
             * Changes the direction of wave propagation.
             */
            function toggleDirection() {
                waveDirection *= -1;
                directionBtn.textContent = waveDirection === 1 ? 'Direction: L-to-R' : 'Direction: R-to-L';
                if (!isPlaying) {
                    update();
                    draw();
                }
            }

            // --- Event Listeners ---
            playPauseBtn.addEventListener('click', togglePlayPause);
            stepBtn.addEventListener('click', step);
            resetBtn.addEventListener('click', reset);
            directionBtn.addEventListener('click', toggleDirection);
            window.addEventListener('resize', () => {
                // Handle resize: stop animation, re-init, and draw
                if(isPlaying) togglePlayPause();
                init();
            });

            // --- Start ---
            init();
        });
    </script>

</body>
</html>
